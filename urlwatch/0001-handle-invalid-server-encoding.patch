From 305f630b4a9288614ba9b3a6b670e978113d35cf Mon Sep 17 00:00:00 2001
From: Thomas Perl <m@thp.io>
Date: Wed, 29 Jan 2014 20:09:30 +0100
Subject: [PATCH] Handle invalid encoding sent by server (fixes Debian bug 731931)

---
 lib/urlwatch/handler.py |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/lib/urlwatch/handler.py b/lib/urlwatch/handler.py
index b694ea5..c6d50bd 100755
--- a/lib/urlwatch/handler.py
+++ b/lib/urlwatch/handler.py
@@ -137,7 +137,12 @@ class UrlJob(JobBase):

         # Convert from specified encoding to unicode
         if not isinstance(content, unicode):
-            content = content.decode(encoding, 'ignore')
+            try:
+                content = content.decode(encoding, 'ignore')
+            except LookupError:
+                # If this is an invalid encoding, decode as ascii
+                # (Debian bug 731931)
+                content = content.decode('ascii', 'ignore')

         return use_filter(filter_func, self.location, content)

--
1.7.0.9.GIT
